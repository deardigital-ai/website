name: Issue Comment Workflow

on:
  issues:
    types: [opened]

jobs:
  comment-on-issue:
    runs-on: self-hosted  # This specifies that the job should run on a self-hosted runner

    steps:
      - name: Check for Duplicate Issues
        id: duplicate_check
        run: |
          # Get the issue title and body
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Fetch recent open issues
          OPEN_ISSUES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open&per_page=15" | \
            jq -r '.[] | select(.number != ${{ github.event.issue.number }}) | "Issue #\(.number): \(.title)\nDescription: \(.body)\n"')
          
          # Create a prompt for the Ollama model to check for duplicates
          DUPLICATE_PROMPT=$(cat << EOT | jq -sR .
          You are a helpful issue analyzer for a GitHub repository. Your task is to determine if a new issue is likely a duplicate of existing open issues.

          New Issue Title: ${ISSUE_TITLE}
          New Issue Body: ${ISSUE_BODY}

          Existing Open Issues:
          ${OPEN_ISSUES}

          Is this a duplicate? Respond with ONLY ONE of these exact formats:
          1. If it's a duplicate: "DUPLICATE:#X" where X is the issue number it duplicates
          2. If it's not a duplicate: "UNIQUE"
          
          Don't include any other text in your response.
          EOT
          )
          
          # Call Ollama API to analyze for duplicates
          DUPLICATE_RESULT=$(curl -s http://localhost:11434/api/generate -d "{
            \"model\": \"llama3.2:latest\",
            \"prompt\": ${DUPLICATE_PROMPT},
            \"stream\": false
          }" | jq -r '.response' | tr -d '[:space:]')
          
          # Save the duplicate check result
          echo "result=${DUPLICATE_RESULT}" >> $GITHUB_OUTPUT
          
          # Extract duplicate issue number if applicable
          if [[ "${DUPLICATE_RESULT}" == DUPLICATE:* ]]; then
            DUPLICATE_ISSUE=$(echo "${DUPLICATE_RESULT}" | cut -d':' -f2)
            echo "duplicate_issue=${DUPLICATE_ISSUE}" >> $GITHUB_OUTPUT
            echo "is_duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "is_duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle Duplicate Issue
        if: steps.duplicate_check.outputs.is_duplicate == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const duplicateIssue = '${{ steps.duplicate_check.outputs.duplicate_issue }}';
            
            // Add duplicate label
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['duplicate']
            });
            
            // Comment about the duplicate
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `This appears to be a duplicate of issue #${duplicateIssue}. Closing this issue as a duplicate.`
            });
            
            // Close the issue
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'duplicate'
            });

      - name: Moderate Issue Content
        id: moderation
        if: steps.duplicate_check.outputs.is_duplicate != 'true'
        run: |
          # Get the issue title and body
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Create a prompt for the Ollama model to analyze relevance
          MODERATION_PROMPT=$(cat << EOT | jq -sR .
          You are a helpful issue moderator for a GitHub repository. Analyze the following issue and determine if it's relevant to a software project.

          Guidelines for classification:
          - RELEVANT: Issues that describe bugs, feature requests, or questions about the software's functionality. Even vague reports about software not working should be considered RELEVANT if they appear to be about the software.
          - IRRELEVANT: Spam, marketing, or completely unrelated content.
          - UNCLEAR: Only use this if you cannot determine if it's related to the software at all.

          Respond with ONLY ONE of these exact words: 'RELEVANT', 'IRRELEVANT', or 'UNCLEAR'. Don't include any other text in your response.
          
          Issue Title: ${ISSUE_TITLE}
          Issue Description: ${ISSUE_BODY}
          EOT
          )
          
          # Call Ollama API to analyze relevance
          MODERATION_RESULT=$(curl -s http://localhost:11434/api/generate -d "{
            \"model\": \"llama3.2:latest\",
            \"prompt\": ${MODERATION_PROMPT},
            \"stream\": false
          }" | jq -r '.response' | tr -d '[:space:]' | tr '[:lower:]' '[:upper:]')
          
          # Save the moderation result
          echo "result=${MODERATION_RESULT}" >> $GITHUB_OUTPUT
          
          # Create a prompt for the Ollama model to generate a response based on relevance
          if [[ "$MODERATION_RESULT" == "RELEVANT" ]]; then
            RESPONSE_PROMPT=$(cat << EOT | jq -sR .
          You are a helpful assistant responding to a GitHub issue. This issue has been determined to be RELEVANT to the project. Generate a friendly, helpful response thanking the user for creating the issue and acknowledging their contribution. Mention that the team will review it soon. Keep it concise (2-3 sentences max) and professional. 
          
          Issue Title: ${ISSUE_TITLE}
          Issue Description: ${ISSUE_BODY}
          EOT
            )
          elif [[ "$MODERATION_RESULT" == "IRRELEVANT" ]]; then
            RESPONSE_PROMPT=$(cat << EOT | jq -sR .
          You are a helpful assistant responding to a GitHub issue. This issue has been determined to be IRRELEVANT to the project. Generate a polite response explaining that the issue appears to be outside the scope of this project. Suggest that they might want to check the project documentation or create a more specific issue. Keep it concise (2-3 sentences max), professional, and non-confrontational.
          
          Issue Title: ${ISSUE_TITLE}
          Issue Description: ${ISSUE_BODY}
          EOT
            )
          else
            RESPONSE_PROMPT=$(cat << EOT | jq -sR .
          You are a helpful assistant responding to a GitHub issue. The relevance of this issue is UNCLEAR. Generate a response asking for more information to help understand how this relates to the project. Be polite and helpful, suggesting what kind of details would be useful. Keep it concise (2-3 sentences max) and professional.
          
          Issue Title: ${ISSUE_TITLE}
          Issue Description: ${ISSUE_BODY}
          EOT
            )
          fi
          
          # Call Ollama API to generate a response
          RESPONSE=$(curl -s http://localhost:11434/api/generate -d "{
            \"model\": \"llama3.2:latest\",
            \"prompt\": ${RESPONSE_PROMPT},
            \"stream\": false
          }" | jq -r '.response')
          
          # Save the response to an output variable, escaping newlines for GitHub Actions
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment on Issue
        if: steps.duplicate_check.outputs.is_duplicate != 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const aiResponse = `${{ steps.moderation.outputs.response }}`;
            const moderationResult = '${{ steps.moderation.outputs.result }}';
            
            console.log(`Moderation result: ${moderationResult}`);
            
            // Fallback message in case the AI response is empty
            let message = aiResponse.trim() || 'Thanks for creating the issue. We appreciate your contribution!';
            
            // Add a label based on the moderation result
            if (moderationResult === 'RELEVANT') {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['relevant']
              });
            } else if (moderationResult === 'IRRELEVANT') {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['irrelevant']
              });
            } else {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['needs-clarification']
              });
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            }); 